<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Links Admin</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: #000000;
            color: #F2F2F2;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(242, 5, 68, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(124, 5, 242, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(5, 108, 242, 0.1) 0%, transparent 50%);
            background-attachment: fixed;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(12px);
            overflow: hidden;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.05);
        }
        
        .header {
            background: linear-gradient(135deg, 
                rgba(242, 5, 68, 0.2) 0%, 
                rgba(124, 5, 242, 0.2) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #F2F2F2;
            padding: 40px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #F20544, #7C05F2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        .section {
            padding: 32px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            position: relative;
        }
        
        .section h3 {
            color: #ffffff;
            margin-bottom: 24px;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .section h3::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #F20544, #7C05F2);
            border-radius: 2px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-group label.clickable-label {
            color: #F20544;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            position: relative;
            display: inline-block;
        }
        
        .form-group label.clickable-label:hover {
            color: #7C05F2;
            text-shadow: 0 0 8px rgba(242, 5, 68, 0.5);
        }
        
        .form-group label.clickable-label::after {
            content: 'â†—';
            margin-left: 8px;
            font-size: 0.75rem;
            opacity: 0.7;
            transition: all 0.3s ease;
        }
        
        .form-group label.clickable-label:hover::after {
            opacity: 1;
            transform: translateX(2px) translateY(-1px);
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 13px;
            color: #ffffff;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.3s ease;
            min-width: 0; /* Allow input to shrink */
        }
        
        /* Specific styling for URL inputs */
        input[type="url"] {
            font-size: 12px;
            letter-spacing: 0.5px;
            text-overflow: ellipsis;
        }
        
        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #F20544;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(242, 5, 68, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, 
                rgba(242, 5, 68, 0.8) 0%, 
                rgba(124, 5, 242, 0.8) 100%);
            color: #F2F2F2;
            border: none;
            padding: 14px 28px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.2), 
                transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(242, 5, 68, 0.3);
            background: linear-gradient(135deg, 
                rgba(242, 5, 68, 1) 0%, 
                rgba(124, 5, 242, 1) 100%);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .current-class {
            text-align: center;
            padding: 24px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .current-class code {
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: #F20544;
        }
        
        .weeks-container {
            display: none;
        }
        
        .weeks-container.active {
            display: block;
        }
        
        .weeks-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 32px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .week-card {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        
        .week-lectures {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .lecture-group {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .week-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #F20544, #7C05F2, #056CF2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .week-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(242, 5, 68, 0.3);
            transform: translateY(-2px);
        }
        
        .week-card:hover::before {
            opacity: 1;
        }
        
        .week-card h4 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .controls {
            text-align: center;
            padding: 32px 0;
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .status {
            margin-top: 24px;
            padding: 16px 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: 500;
            display: none;
            border: 1px solid transparent;
        }
        
        .status.success {
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
            border-color: rgba(34, 197, 94, 0.2);
            display: block;
        }
        
        .status.error {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
            border-color: rgba(239, 68, 68, 0.2);
            display: block;
        }
        
        .status.loading {
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
            border-color: rgba(59, 130, 246, 0.2);
            display: block;
        }
        
        .help-text {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 6px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Checkbox styling */
        input[type="checkbox"] {
            width: auto !important;
            margin-right: 8px;
            accent-color: #F20544;
        }
        
        /* Select dropdown styling */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23F20544' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
            appearance: none;
        }
        
        /* Dropdown options styling */
        select option {
            background-color: #2a2a2a;
            color: #ffffff;
            padding: 10px;
        }
        
        select option:hover,
        select option:focus,
        select option:checked {
            background-color: #3a3a3a;
            color: #F20544;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(242, 5, 68, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(242, 5, 68, 0.5);
        }
        
        /* Animation for fade-ins */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .weeks-container.active {
            animation: fadeIn 0.5s ease;
        }
        
        /* Class-specific background gradients */
        body.class-avc185 {
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(242, 5, 68, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(242, 5, 135, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(242, 5, 68, 0.1) 0%, transparent 50%);
        }
        
        body.class-avc200 {
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(124, 5, 242, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(242, 5, 135, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(124, 5, 242, 0.1) 0%, transparent 50%);
        }
        
        body.class-avc240 {
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(5, 108, 242, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(124, 5, 242, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(5, 108, 242, 0.1) 0%, transparent 50%);
        }
        
        body.class-avc285 {
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(242, 5, 135, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(5, 108, 242, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(242, 5, 68, 0.1) 0%, transparent 50%);
        }
        
        /* Visual class indicator in header */
        .class-indicator {
            position: absolute;
            top: 12px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            transition: all 0.3s ease;
        }
        
        body.class-avc185 .class-indicator {
            background: linear-gradient(135deg, rgba(242, 5, 68, 0.3), rgba(242, 5, 135, 0.3));
            border: 1px solid rgba(242, 5, 68, 0.4);
            color: #F20544;
        }
        
        body.class-avc200 .class-indicator {
            background: linear-gradient(135deg, rgba(124, 5, 242, 0.3), rgba(242, 5, 135, 0.3));
            border: 1px solid rgba(124, 5, 242, 0.4);
            color: #7C05F2;
        }
        
        body.class-avc240 .class-indicator {
            background: linear-gradient(135deg, rgba(5, 108, 242, 0.3), rgba(124, 5, 242, 0.3));
            border: 1px solid rgba(5, 108, 242, 0.4);
            color: #056CF2;
        }
        
        body.class-avc285 .class-indicator {
            background: linear-gradient(135deg, rgba(242, 5, 135, 0.3), rgba(242, 5, 68, 0.3));
            border: 1px solid rgba(242, 5, 135, 0.4);
            color: #F20587;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .header, .section {
                padding: 24px;
            }
            
            .weeks-grid {
                gap: 16px;
                max-width: 100%;
            }
            
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .class-indicator {
                position: relative;
                top: auto;
                right: auto;
                margin-top: 16px;
                display: inline-block;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="class-indicator" id="classIndicator" style="display: none;">AVC 185</div>
            <h1>Multi-Class Lecture Links Admin</h1>
            <p>Manage YouTube lecture links for all your classes</p>
        </div>
        
        <div class="section">
            <h3>GitHub Authentication</h3>
            <div class="form-group">
                <label for="githubToken">GitHub Personal Access Token:</label>
                <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                <div class="help-text">Create at GitHub â†’ Settings â†’ Developer Settings â†’ Personal Access Tokens</div>
            </div>
            <div class="form-group">
                <label for="repoOwner">GitHub Username:</label>
                <input type="text" id="repoOwner" placeholder="yourusername">
            </div>
            <div class="form-group">
                <label for="repoName">Repository Name:</label>
                <input type="text" id="repoName" placeholder="lecture-redirects">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="rememberCredentials"> Remember credentials (stored locally in browser)
                </label>
                <button type="button" class="btn" id="clearCredentials" style="margin-left: 10px; padding: 8px 16px; font-size: 12px;">Clear Saved</button>
            </div>
        </div>
        
        <div class="section">
            <h3>Select Class to Manage:</h3>
            <div class="form-group">
                <label for="classSelect">Class:</label>
                <select id="classSelect" style="width: 200px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <option value="">Choose a class...</option>
                    <option value="avc185" selected>AVC 185</option>
                    <option value="avc200">AVC 200</option>
                    <option value="avc240">AVC 240</option>
                    <option value="avc285">AVC 285</option>
                </select>
            </div>
            
            <div class="current-class" id="currentClassInfo">
                <p><strong id="currentClassName">AVC 185</strong></p>
                <p>Canvas URL format: <code id="urlExample">https://caseyfarina.github.io/lecture-redirects/?class=avc185&lecture=week1-lecture1</code></p>
            </div>
        </div>
        
        <div class="weeks-container" id="weeksContainer">
            <div class="section">
                <h3>Lecture URLs</h3>
                <div class="weeks-grid" id="weeksGrid">
                    <!-- Week cards will be generated here -->
                </div>
                
                <div class="controls">
                    <button class="btn" id="updateLinks">Update All Weeks</button>
                </div>
                
                <div class="status" id="status"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CLASSES = {
            'avc185': 'AVC 185',
            'avc200': 'AVC 200', 
            'avc240': 'AVC 240',
            'avc285': 'AVC 285'
        };
        
        let currentClass = null;
        
        
        // Show status message
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }
        
        // Select class
        function selectClass(classKey) {
            console.log('selectClass called with:', classKey);
            currentClass = classKey;
            
            // Remove all class-specific body classes
            document.body.classList.remove('class-avc185', 'class-avc200', 'class-avc240', 'class-avc285');
            
            if (!classKey) {
                // Hide everything if no class selected
                document.getElementById('weeksContainer').classList.remove('active');
                document.getElementById('classIndicator').style.display = 'none';
                return;
            }
            
            // Add class-specific body class for background gradient
            document.body.classList.add(`class-${classKey}`);
            
            // Update and show class indicator
            const classIndicator = document.getElementById('classIndicator');
            classIndicator.textContent = CLASSES[classKey];
            classIndicator.style.display = 'block';
            
            // Update dropdown
            document.getElementById('classSelect').value = classKey;
            
            // Show class info
            const classInfo = document.getElementById('currentClassInfo');
            const className = document.getElementById('currentClassName');
            const urlExample = document.getElementById('urlExample');
            
            className.textContent = CLASSES[classKey];
            
            const owner = document.getElementById('repoOwner').value || 'caseyfarina';
            const repo = document.getElementById('repoName').value || 'lecture-redirects';
            urlExample.textContent = `https://${owner}.github.io/${repo}/?class=${classKey}&lecture=week1-lecture1`;
            
            classInfo.style.display = 'block';
            
            // Show weeks container
            document.getElementById('weeksContainer').classList.add('active');
            
            // Clear existing forms and regenerate with class-specific labels
            const grid = document.getElementById('weeksGrid');
            grid.innerHTML = '';
            generateWeekForms();
            
            // Auto-load current links from repository (delay to ensure forms are rendered)
            setTimeout(() => {
                autoLoadCurrentLinks();
            }, 200);
            
            showStatus(`Selected ${CLASSES[classKey]} - Loading current links...`, 'loading');
        }
        
        // Auto-load current links (simplified version without user prompts)
        async function autoLoadCurrentLinks() {
            const token = document.getElementById('githubToken').value;
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            
            // Skip if credentials not available
            if (!token || !owner || !repo || !currentClass) {
                console.log('Skipping auto-load: missing credentials or class not selected');
                if (currentClass) {
                    showStatus(`${CLASSES[currentClass]} selected - Enter GitHub credentials to load current links`, 'error');
                }
                return;
            }
            
            console.log('Auto-loading current links for:', currentClass);
            
            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/index.html`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const data = await response.json();
                const content = atob(data.content);
                
                // Extract links for current class
                const classRegex = new RegExp(`'${currentClass}':\\s*\\{([^}]+)\\}`, 's');
                const classMatch = content.match(classRegex);
                
                let loadedCount = 0;
                
                if (classMatch) {
                    const classContent = classMatch[1];
                    console.log('Found class content:', classContent.substring(0, 200) + '...');
                    const linkRegex = /'(week\d+-lecture\d+)':\s*'([^']+)'/g;
                    let match;
                    
                    while ((match = linkRegex.exec(classContent)) !== null) {
                        const [, key, url] = match;
                        const input = document.getElementById(key);
                        console.log(`Found match - Key: ${key}, URL: ${url}, Input exists: ${!!input}`);
                        
                        if (input) {
                            // Load all URLs, not just non-defaults
                            input.value = url;
                            loadedCount++;
                            console.log(`Set ${key} = ${url}`);
                        } else {
                            console.warn(`Input field not found for: ${key}`);
                        }
                    }
                }
                
                showStatus(`${CLASSES[currentClass]} selected - ${loadedCount} current links loaded automatically`, 'success');
                
            } catch (error) {
                console.error('Error auto-loading links:', error);
                showStatus(`${CLASSES[currentClass]} selected - Could not auto-load links (${error.message})`, 'error');
            }
        }
        
        // Generate week input forms
        function generateWeekForms() {
            const grid = document.getElementById('weeksGrid');
            
            for (let week = 1; week <= 16; week++) {
                const weekCard = document.createElement('div');
                weekCard.className = 'week-card';
                const classDisplayName = currentClass ? CLASSES[currentClass] : 'Week';
                weekCard.innerHTML = `
                    <h4>${classDisplayName} Week ${week}</h4>
                    <div class="week-lectures">
                        <div class="lecture-group">
                            <div class="form-group">
                                <label for="week${week}-lecture1" class="clickable-label" data-redirect="week${week}-lecture1" title="Click to test redirect">Lecture 1</label>
                                <input type="url" id="week${week}-lecture1" placeholder="https://www.youtube.com/watch?v=...">
                            </div>
                        </div>
                        <div class="lecture-group">
                            <div class="form-group">
                                <label for="week${week}-lecture2" class="clickable-label" data-redirect="week${week}-lecture2" title="Click to test redirect">Lecture 2</label>
                                <input type="url" id="week${week}-lecture2" placeholder="https://www.youtube.com/watch?v=...">
                            </div>
                        </div>
                        <div class="week-update-controls" style="margin-top: 16px; text-align: center;">
                            <button class="btn week-update-btn" data-week="${week}" style="padding: 8px 16px; font-size: 12px;">Update ${classDisplayName} Week ${week}</button>
                        </div>
                    </div>
                `;
                grid.appendChild(weekCard);
            }
            
            // Add click event listeners to all clickable labels
            addClickableLabelsEventListeners();
            
            // Add event listeners to week update buttons
            addWeekUpdateButtonListeners();
            
            console.log('Week forms generated');
        }
        
        // Add event listeners for week update buttons
        function addWeekUpdateButtonListeners() {
            document.querySelectorAll('.week-update-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const week = this.dataset.week;
                    updateSingleWeek(week);
                });
            });
        }
        
        // Update a single week's lectures
        async function updateSingleWeek(week) {
            console.log(`updateSingleWeek called for week ${week}`);
            
            if (!currentClass) {
                showStatus('Please select a class first', 'error');
                return;
            }
            
            const token = document.getElementById('githubToken').value;
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            
            if (!token || !owner || !repo) {
                showStatus('Please fill in all GitHub authentication fields', 'error');
                return;
            }
            
            // Collect links for this specific week
            const weekLinks = {};
            const lecture1Input = document.getElementById(`week${week}-lecture1`);
            const lecture2Input = document.getElementById(`week${week}-lecture2`);
            
            if (lecture1Input && lecture1Input.value) {
                const url = normalizeYouTubeUrl(lecture1Input.value);
                if (url) weekLinks[`week${week}-lecture1`] = url;
            }
            
            if (lecture2Input && lecture2Input.value) {
                const url = normalizeYouTubeUrl(lecture2Input.value);
                if (url) weekLinks[`week${week}-lecture2`] = url;
            }
            
            if (Object.keys(weekLinks).length === 0) {
                showStatus(`No lecture URLs found for Week ${week}. Please enter some URLs first.`, 'error');
                return;
            }
            
            // Visual feedback for the specific week button
            const weekButton = document.querySelector(`[data-week="${week}"]`);
            const originalText = weekButton.textContent;
            const originalBackground = weekButton.style.background;
            
            weekButton.style.background = '#ffa500';
            weekButton.textContent = 'Updating...';
            weekButton.disabled = true;
            
            showStatus(`Updating Week ${week}...`, 'loading');
            
            try {
                // Get current file
                const getResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/index.html`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getResponse.ok) {
                    const errorText = await getResponse.text();
                    console.error('GitHub API error response:', errorText);
                    throw new Error(`Failed to get current file: ${getResponse.status} - ${errorText}`);
                }
                
                const currentFile = await getResponse.json();
                const currentContent = atob(currentFile.content);
                console.log('Successfully retrieved current file for week update');
                
                let updatedContent = currentContent;
                
                // Update each lecture link for this week
                for (const [lectureKey, url] of Object.entries(weekLinks)) {
                    const lecturePattern = new RegExp(`('${lectureKey}':\\s*')[^']+(')`);
                    const match = updatedContent.match(lecturePattern);
                    
                    if (match) {
                        updatedContent = updatedContent.replace(lecturePattern, `$1${url}$2`);
                        console.log(`Updated ${lectureKey} = ${url}`);
                    } else {
                        console.warn(`Could not find pattern for ${lectureKey}`);
                    }
                }
                
                // Update file
                const updateResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/index.html`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update ${CLASSES[currentClass]} Week ${week} lecture links`,
                        content: btoa(updatedContent),
                        sha: currentFile.sha
                    })
                });
                
                if (!updateResponse.ok) {
                    const errorText = await updateResponse.text();
                    console.error('Update failed:', errorText);
                    throw new Error(`Failed to update file: ${updateResponse.status} - ${errorText}`);
                }
                
                const updateResult = await updateResponse.json();
                console.log('Week update successful:', updateResult);
                
                showStatus(`Week ${week} updated successfully! ${Object.keys(weekLinks).length} links updated for ${CLASSES[currentClass]}.`, 'success');
                
            } catch (error) {
                console.error('Error updating week:', error);
                showStatus(`Error updating Week ${week}: ${error.message}`, 'error');
            } finally {
                // Reset button
                weekButton.style.background = originalBackground;
                weekButton.textContent = originalText;
                weekButton.disabled = false;
            }
        }
        
        // Add event listeners for clickable labels
        function addClickableLabelsEventListeners() {
            document.querySelectorAll('.clickable-label').forEach(label => {
                label.addEventListener('click', function(e) {
                    e.preventDefault();
                    const lectureKey = this.dataset.redirect;
                    
                    if (!currentClass) {
                        showStatus('Please select a class first', 'error');
                        return;
                    }
                    
                    const owner = document.getElementById('repoOwner').value || 'caseyfarina';
                    const repo = document.getElementById('repoName').value || 'lecture-redirects';
                    
                    const redirectUrl = `https://${owner}.github.io/${repo}/?class=${currentClass}&lecture=${lectureKey}`;
                    
                    console.log(`Testing redirect: ${redirectUrl}`);
                    
                    // Open in new tab for testing
                    window.open(redirectUrl, '_blank');
                    
                    // Also copy to clipboard for easy pasting into Canvas
                    navigator.clipboard.writeText(redirectUrl).then(() => {
                        showStatus(`Redirect URL copied to clipboard: ${redirectUrl}`, 'success');
                    }).catch(() => {
                        showStatus(`Redirect URL: ${redirectUrl}`, 'success');
                    });
                });
            });
        }
        
        // Normalize YouTube URLs
        function normalizeYouTubeUrl(url) {
            if (!url || url.trim() === '') return '';
            
            const shortMatch = url.match(/youtu\.be\/([a-zA-Z0-9_-]+)/);
            if (shortMatch) {
                return `https://www.youtube.com/watch?v=${shortMatch[1]}`;
            }
            
            const longMatch = url.match(/youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]+)/);
            if (longMatch) {
                return `https://www.youtube.com/watch?v=${longMatch[1]}`;
            }
            
            return url;
        }
        
        // Collect lecture links
        function collectLectureLinks() {
            const links = {};
            
            for (let week = 1; week <= 16; week++) {
                const lecture1Input = document.getElementById(`week${week}-lecture1`);
                const lecture2Input = document.getElementById(`week${week}-lecture2`);
                
                if (lecture1Input && lecture1Input.value) {
                    const url = normalizeYouTubeUrl(lecture1Input.value);
                    if (url) links[`week${week}-lecture1`] = url;
                }
                
                if (lecture2Input && lecture2Input.value) {
                    const url = normalizeYouTubeUrl(lecture2Input.value);
                    if (url) links[`week${week}-lecture2`] = url;
                }
            }
            
            return links;
        }
        
        // Update repository
        async function updateRepository() {
            console.log('updateRepository called');
            
            if (!currentClass) {
                showStatus('Please select a class first', 'error');
                return;
            }
            
            const token = document.getElementById('githubToken').value;
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            
            console.log('GitHub credentials:', { 
                tokenLength: token ? token.length : 0,
                owner: owner,
                repo: repo 
            });
            
            if (!token || !owner || !repo) {
                showStatus('Please fill in all GitHub authentication fields', 'error');
                return;
            }
            
            // Collect links first to see what we're trying to update
            const newLinks = collectLectureLinks();
            console.log('Collected links for update:', newLinks);
            
            if (Object.keys(newLinks).length === 0) {
                showStatus('No lecture URLs found to update. Please enter some URLs first.', 'error');
                return;
            }
            
            showStatus('Updating repository...', 'loading');
            
            try {
                // Get current file
                const getResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/index.html`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getResponse.ok) {
                    const errorText = await getResponse.text();
                    console.error('GitHub API error response:', errorText);
                    throw new Error(`Failed to get current file: ${getResponse.status} - ${errorText}`);
                }
                
                const currentFile = await getResponse.json();
                const currentContent = atob(currentFile.content);
                console.log('Successfully retrieved current file, length:', currentContent.length);
                
                // We already collected links above, use the same variable
                console.log('Processing links for class:', currentClass, newLinks);
                
                // Build new class section
                let newClassSection = '';
                for (let week = 1; week <= 16; week++) {
                    newClassSection += `                // Week ${week}\n`;
                    const lecture1Key = `week${week}-lecture1`;
                    const lecture2Key = `week${week}-lecture2`;
                    
                    const lecture1Url = newLinks[lecture1Key] || 'https://caseyfarina.github.io/lecture-redirects/not-found.html';
                    const lecture2Url = newLinks[lecture2Key] || 'https://caseyfarina.github.io/lecture-redirects/not-found.html';
                    
                    newClassSection += `                '${lecture1Key}': '${lecture1Url}',\n`;
                    newClassSection += `                '${lecture2Key}': '${lecture2Url}',\n`;
                    
                    if (week < 16) {
                        newClassSection += `\n`;
                    }
                }
                
                console.log('Generated new class section preview:', newClassSection.substring(0, 200) + '...');
                
                // Replace the class section in the content
                const classPattern = new RegExp(`(\\s*'${currentClass}':\\s*\\{)[^}]+(\\s*\\})`);
                console.log('Regex pattern for class:', classPattern.toString());
                
                const match = currentContent.match(classPattern);
                console.log('Pattern match found:', !!match);
                
                if (!match) {
                    throw new Error(`Could not find class '${currentClass}' in index.html. Please check the file structure.`);
                }
                
                const updatedContent = currentContent.replace(classPattern, `$1\n${newClassSection}            $2`);
                console.log('Content updated, new length:', updatedContent.length);
                
                // Update file
                const updateResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/index.html`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update ${CLASSES[currentClass]} lecture links`,
                        content: btoa(updatedContent),
                        sha: currentFile.sha
                    })
                });
                
                if (!updateResponse.ok) {
                    const errorText = await updateResponse.text();
                    console.error('Update failed:', errorText);
                    throw new Error(`Failed to update file: ${updateResponse.status} - ${errorText}`);
                }
                
                const updateResult = await updateResponse.json();
                console.log('Update successful:', updateResult);
                
                showStatus(`Repository updated successfully! ${Object.keys(newLinks).length} links updated for ${CLASSES[currentClass]}.`, 'success');
                
            } catch (error) {
                console.error('Error updating repository:', error);
                showStatus(`Error updating repository: ${error.message}`, 'error');
            }
        }
        
        // Save credentials to localStorage
        function saveCredentials() {
            const shouldRemember = document.getElementById('rememberCredentials').checked;
            
            if (shouldRemember) {
                const credentials = {
                    token: document.getElementById('githubToken').value,
                    owner: document.getElementById('repoOwner').value,
                    repo: document.getElementById('repoName').value
                };
                localStorage.setItem('lectureAdminCredentials', JSON.stringify(credentials));
                console.log('Credentials saved to localStorage');
            }
        }
        
        // Load credentials from localStorage
        function loadCredentials() {
            const saved = localStorage.getItem('lectureAdminCredentials');
            if (saved) {
                try {
                    const credentials = JSON.parse(saved);
                    document.getElementById('githubToken').value = credentials.token || '';
                    document.getElementById('repoOwner').value = credentials.owner || '';
                    document.getElementById('repoName').value = credentials.repo || '';
                    document.getElementById('rememberCredentials').checked = true;
                    console.log('Credentials loaded from localStorage');
                } catch (error) {
                    console.error('Error loading saved credentials:', error);
                    localStorage.removeItem('lectureAdminCredentials');
                }
            }
        }
        
        // Clear saved credentials
        function clearCredentials() {
            localStorage.removeItem('lectureAdminCredentials');
            document.getElementById('githubToken').value = '';
            document.getElementById('repoOwner').value = '';
            document.getElementById('repoName').value = '';
            document.getElementById('rememberCredentials').checked = false;
            showStatus('Saved credentials cleared', 'success');
            console.log('Credentials cleared from localStorage');
        }

        // Initialize when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded - initializing admin interface');
            
            // Load saved credentials first
            loadCredentials();
            
            
            // Class dropdown
            document.getElementById('classSelect').addEventListener('change', function() {
                const classKey = this.value;
                selectClass(classKey);
            });
            
            // Auto-select AVC 185 on load - delay to ensure credentials are loaded
            setTimeout(() => {
                const initialClass = 'avc185';
                console.log('Auto-selecting AVC 185 on page load...');
                selectClass(initialClass);
            }, 100);
            
            document.getElementById('updateLinks').addEventListener('click', function(e) {
                console.log('Update Repository button clicked');
                
                // Visual feedback that button was clicked
                const btn = this;
                const originalText = btn.textContent;
                const originalBackground = btn.style.background;
                
                btn.style.background = '#ffa500';
                btn.textContent = 'Processing...';
                btn.disabled = true;
                
                updateRepository().finally(() => {
                    // Reset button after operation completes
                    btn.style.background = originalBackground;
                    btn.textContent = originalText;
                    btn.disabled = false;
                });
            });
            
            // Clear credentials button
            document.getElementById('clearCredentials').addEventListener('click', clearCredentials);
            
            // Auto-save credentials when checkbox is checked and fields change
            function autoSaveCredentials() {
                if (document.getElementById('rememberCredentials').checked) {
                    saveCredentials();
                }
            }
            
            // Save credentials when remember checkbox is checked
            document.getElementById('rememberCredentials').addEventListener('change', function() {
                if (this.checked) {
                    saveCredentials();
                } else {
                    localStorage.removeItem('lectureAdminCredentials');
                }
            });
            
            // Auto-save when credentials change (if remember is checked)
            // Also retry auto-loading if credentials are entered after class is selected
            document.getElementById('githubToken').addEventListener('input', function() {
                autoSaveCredentials();
                if (currentClass && this.value) {
                    console.log('GitHub token entered, retrying auto-load...');
                    setTimeout(autoLoadCurrentLinks, 500);
                }
            });
            document.getElementById('repoOwner').addEventListener('input', autoSaveCredentials);
            document.getElementById('repoName').addEventListener('input', autoSaveCredentials);
            
            console.log('Admin interface initialized successfully');
        });
    </script>
</body>
</html>